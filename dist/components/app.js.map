{"version":3,"sources":["webpack:///./components/app.js"],"names":["App","evt","console","error","detail","title","document","put","__appSignature","location","window","history","handlers","middlewares","__started","hashSeparator","reHashSeparator","RegExp","manual","async","start","pattern","match","str","chunks","split","length","Error","tokens","re","replace","g","token","push","optRe","slice","route","callback","routeHandler","type","args","__isStatic","result","__routeRegExp","__middlewareChainRun","compose","__execute","executed","info","is","__id","__listenNavigation","fire","__executeCallback","mode","event","on","defaultPrevented","target","nodeName","preventDefault","state","url","getAttribute","pushState","innerHTML","href","fragment","getFragment","reduce","executors","handler","forEach","name","index","getFragmentExecutors","context","uri","executor","path","options","rootUri","toString","origin","middleware","decodeURI","pathname","search","docTitle","String","value","observer","Boolean","Component","define","fn","TypeError","next","i","dispatch"],"mappings":";;;;;;;;;;;;AAAA;;;;;;;;;;;;;;KAEMA,G;;;;;;;;;;;yCAqCiBC,G,EAAK;AACxBC,eAAQC,KAAR,CAAc,sBAAsBF,IAAIG,MAAxC;AACD;;;mCAEcC,K,EAAO;AACpBC,gBAASD,KAAT,GAAiBA,KAAjB;AACD;;;+BAEU;AACT,qBAAIE,GAAJ,CAAQ,KAAR,EAAe,IAAf;;AAEA;;AAEA,YAAKC,cAAL,GAAsB,IAAtB;AACA,YAAKC,QAAL,GAAgBC,OAAOD,QAAvB;AACA,YAAKE,OAAL,GAAeD,OAAOC,OAAtB;;AAEA;AACA,YAAKC,QAAL,GAAgB,EAAhB;AACA,YAAKC,WAAL,GAAmB,EAAnB;;AAEA,YAAKC,SAAL,GAAiB,KAAjB;AACD;;;2CAEsBC,a,EAAe;AACpC,YAAKC,eAAL,GAAuB,IAAIC,MAAJ,CAAWF,gBAAgB,OAA3B,CAAvB;AACD;;;gCAEW;AACV,WAAI,CAAC,KAAKG,MAAV,EAAkB;AAChB,cAAKC,KAAL,CAAW,KAAKC,KAAhB;AACD;AACF;;;gCAEWC,O,EAAS;AACnB,cAAO,CAACA,QAAQC,KAAR,CAAc,MAAd,CAAR;AACD;;;mCAEcC,G,EAAK;AAClB,WAAIC,SAASD,IAAIE,KAAJ,CAAU,GAAV,CAAb;;AAEA,WAAID,OAAOE,MAAP,GAAgB,CAApB,EAAuB;AACrB,eAAM,IAAIC,KAAJ,CAAU,gCAAV,CAAN;AACD;;AAED,WAAIC,SAAS,EAAb;AACA,WAAIC,KAAKL,OAAO,CAAP,EAAUM,OAAV,CAAkB,YAAlB,EAAgC,UAAUC,CAAV,EAAaC,KAAb,EAAoB;AAC3DJ,gBAAOK,IAAP,CAAYD,KAAZ;AACA,gBAAO,SAAP;AACD,QAHQ,EAGNF,OAHM,CAGE,KAHF,EAGS,KAHT,CAAT;;AAKA,WAAII,QAAQ,EAAZ;;AAEA,WAAIV,OAAO,CAAP,CAAJ,EAAe;AACbU,iBAAQ,QAAQV,OAAO,CAAP,EAAUW,KAAV,CAAgB,CAAhB,EAAmB,CAAC,CAApB,EAAuBL,OAAvB,CAA+B,YAA/B,EAA6C,UAAUC,CAAV,EAAaC,KAAb,EAAoB;AAC/EJ,kBAAOK,IAAP,CAAYD,KAAZ;AACA,kBAAO,SAAP;AACD,UAHe,EAGbF,OAHa,CAGL,KAHK,EAGE,KAHF,CAAR,GAGmB,IAH3B;AAID;AACD,cAAO,CAAE,IAAIb,MAAJ,CAAW,MAAMY,EAAN,GAAWK,KAAX,GAAmB,GAA9B,CAAF,EAAsCN,MAAtC,CAAP;AACD;;;2BAEMQ,M,EAAOC,Q,EAAU;AACtB,WAAIC,eAAe;AACjBF,gBAAOA,MADU;AAEjBG,eAAM,GAFW;AAGjBlB,kBAAS,IAHQ;AAIjBmB,eAAM,EAJW;AAKjBH,mBAAUA;AALO,QAAnB;;AAQA,WAAI,CAAC,KAAKI,UAAL,CAAgBL,MAAhB,CAAL,EAA6B;AAC3B,aAAIM,SAAS,KAAKC,aAAL,CAAmBP,MAAnB,CAAb;;AAEAE,sBAAaC,IAAb,GAAoB,GAApB;AACAD,sBAAajB,OAAb,GAAuBqB,OAAO,CAAP,CAAvB;AACAJ,sBAAaE,IAAb,GAAoBE,OAAO,CAAP,CAApB;AACD;;AAED,YAAK9B,QAAL,CAAcqB,IAAd,CAAmBK,YAAnB;AACD;;;;;;;;;;sBAGK,KAAKxB,S;;;;;;;;;AAIT,sBAAK8B,oBAAL,GAA4BC,QAAQ,KAAKhC,WAAb,CAA5B;;AAEA;;wBACqB,KAAKiC,SAAL,E;;;AAAjBC,yB;;AACJ;;AAEA,qBAAIA,QAAJ,EAAc;AACZ7C,2BAAQ8C,IAAR,cAAwB,KAAKC,EAA7B,SAAmC,KAAKC,IAAxC;;AAEA,wBAAKpC,SAAL,GAAiB,IAAjB;;AAEA,wBAAKqC,kBAAL;;AAEA,wBAAKC,IAAL,CAAU,SAAV;AACD;;;;;;;;;;;;;;;;;;0CAGmB;AAAA;;AACpB,WAAIf,WAAW,KAAKgB,iBAAL,GAAyB,YAAM;AAC5C,gBAAKP,SAAL;AACD,QAFD;;AAIA,WAAI,KAAKQ,IAAL,KAAc,SAAlB,EAA6B;AAC3B,uBAAIC,KAAJ,CAAU7C,MAAV,EAAkB8C,EAAlB,CAAqB,UAArB,EAAiCnB,QAAjC;AACA,uBAAIkB,KAAJ,CAAUjD,QAAV,EAAoBkD,EAApB,CAAuB,OAAvB,EAAgC,eAAO;AACrC,eAAI,CAACvD,IAAIwD,gBAAL,IAAyBxD,IAAIyD,MAAJ,CAAWC,QAAX,KAAwB,GAAjD,IAAwD1D,IAAIyD,MAAJ,CAAWA,MAAX,KAAsB,EAAlF,EAAsF;AACpFzD,iBAAI2D,cAAJ;;AAEA,iBAAIC,QAAQ,EAAEC,KAAK7D,IAAIyD,MAAJ,CAAWK,YAAX,CAAwB,MAAxB,CAAP,EAAZ;AACA,oBAAKpD,OAAL,CAAaqD,SAAb,CAAuBH,KAAvB,EAA8B5D,IAAIyD,MAAJ,CAAWO,SAAzC,EAAoDhE,IAAIyD,MAAJ,CAAWQ,IAA/D;;AAEA7B;AACD;AACF,UATD;AAUD,QAZD,MAYO;AACL,uBAAIkB,KAAJ,CAAU7C,MAAV,EAAkB8C,EAAlB,CAAqB,YAArB,EAAmCnB,QAAnC;AACD;AACF;;;0CAMqB8B,Q,EAAU;AAC9BA,kBAAWA,YAAY,KAAKC,WAAL,EAAvB;;AAEA,cAAO,KAAKxD,QAAL,CAAcyD,MAAd,CAAqB,UAACC,SAAD,EAAYC,OAAZ,EAAwB;AAClD,aAAIA,QAAQhC,IAAR,KAAiB,GAArB,EAA0B;AACxB,eAAI4B,aAAaI,QAAQnC,KAAzB,EAAgC;AAC9BkC,uBAAUrC,IAAV,CAAe,EAAEsC,SAASA,OAAX,EAAoB/B,MAAM,EAA1B,EAAf;AACD;AACF,UAJD,MAIO,IAAI+B,QAAQhC,IAAR,KAAiB,GAArB,EAA0B;AAAA;AAC/B,iBAAIG,SAASyB,SAAS7C,KAAT,CAAeiD,QAAQlD,OAAvB,CAAb;AACA,iBAAIqB,MAAJ,EAAY;AAAA;AACV,qBAAIF,OAAO,EAAX;;AAEA+B,yBAAQ/B,IAAR,CAAagC,OAAb,CAAqB,UAAUC,IAAV,EAAgBC,KAAhB,EAAuB;AAC1ClC,wBAAKiC,IAAL,IAAa/B,OAAOgC,QAAQ,CAAf,CAAb;AACD,kBAFD;;AAIAJ,2BAAUrC,IAAV,CAAe;AACbsC,4BAASA,OADI;AAEb/B,yBAAMA;AAFO,kBAAf;AAPU;AAWX;AAb8B;AAchC;AACD,gBAAO8B,SAAP;AACD,QArBM,EAqBJ,EArBI,CAAP;AAsBD;;;;;;;;;;AAGKH,yB,GAAW,KAAKC,WAAL,E;AAEXE,0B,GAAY,KAAKK,oBAAL,CAA0BR,QAA1B,C;;uBACZG,UAAU5C,MAAV,KAAqB,C;;;;;AACvB,sBAAK0B,IAAL,CAAU,iBAAV,EAA6Be,QAA7B;mDACO,K;;;AAGLS,wB,GAAU,EAAEC,KAAKV,QAAP,E;;;AAEd,sBAAKf,IAAL,CAAU,WAAV,EAAuBwB,OAAvB;;AAEA;;wBACM,KAAKhC,oBAAL,CAA0BgC,OAA1B,EAAmC,YAAM;AAC7CN,6BAAUE,OAAV,CAAkB;AAAA,4BAAYM,SAASP,OAAT,CAAiBlC,QAAjB,CAA0ByC,SAAStC,IAAnC,EAAyCoC,OAAzC,CAAZ;AAAA,oBAAlB;AACD,kBAFK,C;;;mDAIC,I;;;;;;;;;;;;;;;;;;8BAGCG,I,EAAMC,O,EAAS;AACvBD,cAAOA,QAAQ,GAAf;AACAC,iBAAUA,WAAW,EAArB;;AAEA,WAAI,KAAK1B,IAAL,KAAc,SAAlB,EAA6B;AAC3B,aAAIQ,MAAM,KAAKmB,OAAL,GAAeF,KAAKG,QAAL,GAAgBpD,OAAhB,CAAwB,KAAxB,EAA+B,EAA/B,EAAmCA,OAAnC,CAA2C,KAA3C,EAAkD,EAAlD,CAAzB;AACA,aAAI,KAAKrB,QAAL,CAAcyD,IAAd,CAAmBpC,OAAnB,CAA2B,KAAKrB,QAAL,CAAc0E,MAAzC,EAAiD,EAAjD,MAAyDrB,GAA7D,EAAkE;AAChE,gBAAKnD,OAAL,CAAaqE,QAAQlD,OAAR,GAAkB,cAAlB,GAAmC,WAAhD,EAA6D,EAA7D,EAAiExB,SAASD,KAA1E,EAAiFyD,GAAjF;AACA,gBAAKhB,SAAL;AACD;AACF,QAND,MAMO;AACL,cAAKrC,QAAL,CAAcyD,IAAd,CAAmB5C,KAAnB,CAAyB,KAAKN,eAA9B;AACA,cAAKP,QAAL,CAAcyD,IAAd,GAAqB,KAAKzD,QAAL,CAAcyD,IAAd,CAAmBpC,OAAnB,CAA2B,KAAKd,eAAhC,EAAiD,EAAjD,IAAuD,KAAKD,aAA5D,GAA4EgE,IAAjG;AACD;AACD,cAAO,IAAP;AACD;;;yBAEIK,U,EAAY;AACf,YAAKvE,WAAL,CAAiBoB,IAAjB,CAAsBmD,UAAtB;AACD;;;mCAEc;AACb,WAAIjB,iBAAJ;AACA,WAAI,KAAKb,IAAL,KAAc,SAAlB,EAA6B;AAC3Ba,oBAAWkB,UAAU,KAAK5E,QAAL,CAAc6E,QAAd,GAAyB,KAAK7E,QAAL,CAAc8E,MAAjD,CAAX;AACApB,oBAAWA,SAASrC,OAAT,CAAiB,SAAjB,EAA4B,EAA5B,CAAX;AACAqC,oBAAW,KAAKc,OAAL,KAAiB,GAAjB,GAAuBd,QAAvB,GAAkCA,SAASrC,OAAT,CAAiB,KAAKmD,OAAtB,EAA+B,EAA/B,CAA7C;AACD,QAJD,MAIO;AACL,aAAI3D,QAAQ,KAAKb,QAAL,CAAcyD,IAAd,CAAmB5C,KAAnB,CAAyB,KAAKN,eAA9B,CAAZ;AACAmD,oBAAW7C,QAAQA,MAAM,CAAN,CAAR,GAAmB,EAA9B;AACD;;AAED,cAAO,MAAM6C,SAASe,QAAT,GAAoBpD,OAApB,CAA4B,KAA5B,EAAmC,EAAnC,EAAuCA,OAAvC,CAA+C,KAA/C,EAAsD,EAAtD,CAAb;AACD;;AAED;AACA;AACA;AACA;;;;yBA5Pa;AACX,cAAO;AACL0D,mBAAU;AACRjD,iBAAMkD,MADE;AAERC,kBAAO,aAFC;AAGRC,qBAAU;AAHF,UADL;;AAOLzE,iBAAQ;AACNqB,iBAAMqD;AADA,UAPH;;AAWLtC,eAAM;AACJf,iBAAMkD,MADF;AAEJC,kBAAO;AAFH,UAXD;;AAgBLT,kBAAS;AACP1C,iBAAMkD,MADC;AAEPC,kBAAO;AAFA,UAhBJ;;AAqBL3E,wBAAe;AACbwB,iBAAMkD,MADO;AAEbC,kBAAO,IAFM;AAGbC,qBAAU;AAHG;AArBV,QAAP;AA2BD;;;yBAEgB;AACf,cAAO;AACL,4BAAmB;AADd,QAAP;AAGD;;;yBAgIc;AACb,cAAO,KAAK7E,SAAL,IAAkB,KAAzB;AACD;;;;GArKe,cAAI+E,S;;AAgQtB,eAAIC,MAAJ,CAAW,SAAX,EAAsB9F,GAAtB;;AAEA,UAAS6C,OAAT,CAAkBhC,WAAlB,EAA+B;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAC7B,0BAAiBA,WAAjB,8HAA8B;AAAA,WAAnBkF,EAAmB;;AAC5B,WAAI,OAAOA,EAAP,KAAc,UAAlB,EAA8B;AAC5B,eAAM,IAAIC,SAAJ,CAAc,2CAAd,CAAN;AACD;AACF;AAL4B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAO7B;AAAA,2DAAO,kBAAOpB,OAAP,EAAgBqB,IAAhB;AAAA;AAAA,+DAIL,kBAAyBC,CAAzB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,yBACMA,KAAKxB,KADX;AAAA;AAAA;AAAA;;AAAA,yBAEU,IAAI/C,KAAJ,CAAU,8BAAV,CAFV;;AAAA;;AAKE+C,2BAAQwB,CAAR;AACIH,qBANN,GAMWlF,YAAYqF,CAAZ,CANX;;AAOE,uBAAIA,MAAMrF,YAAYa,MAAtB,EAA8B;AAC5BqE,0BAAKE,IAAL;AACD;;AATH,uBAUOF,EAVP;AAAA;AAAA;AAAA;;AAAA;;AAAA;AAAA;AAAA,0BAceA,GAAGnB,OAAH,EAAY;AAAA,4BAAMuB,SAASD,IAAI,CAAb,CAAN;AAAA,oBAAZ,CAdf;;AAAA;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,UAJK;;AAAA,yBAIUC,QAJV;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AACL;AACIzB,oBAFC,GAEO,CAAC,CAFR;AAAA,iDAqBEyB,SAAS,CAAT,CArBF;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,MAAP;;AAAA;AAAA;AAAA;AAAA;AAuBD;;AAED,eAAInG,GAAJ,GAAUA,GAAV;;mBAEeA,G","file":"components/app.js","sourcesContent":["import xin from '../src';\n\nclass App extends xin.Component {\n  get props () {\n    return {\n      docTitle: {\n        type: String,\n        value: 'Application',\n        observer: '_titleChanged',\n      },\n\n      manual: {\n        type: Boolean,\n      },\n\n      mode: {\n        type: String,\n        value: 'hash',\n      },\n\n      rootUri: {\n        type: String,\n        value: '/',\n      },\n\n      hashSeparator: {\n        type: String,\n        value: '#!',\n        observer: '_hashSeparatorChanged',\n      },\n    };\n  }\n\n  get listeners () {\n    return {\n      'route-not-found': 'handleRouteNotFound(evt)',\n    };\n  }\n\n  handleRouteNotFound (evt) {\n    console.error('Route not found: ' + evt.detail);\n  }\n\n  _titleChanged (title) {\n    document.title = title;\n  }\n\n  created () {\n    xin.put('app', this);\n\n    // this.classList.add('xin-app');\n\n    this.__appSignature = true;\n    this.location = window.location;\n    this.history = window.history;\n\n    // default values\n    this.handlers = [];\n    this.middlewares = [];\n\n    this.__started = false;\n  }\n\n  _hashSeparatorChanged (hashSeparator) {\n    this.reHashSeparator = new RegExp(hashSeparator + '(.*)$');\n  }\n\n  attached () {\n    if (!this.manual) {\n      this.async(this.start);\n    }\n  }\n\n  __isStatic (pattern) {\n    return !pattern.match(/[[{]/);\n  }\n\n  __routeRegExp (str) {\n    let chunks = str.split('[');\n\n    if (chunks.length > 2) {\n      throw new Error('Invalid use of optional params');\n    }\n\n    let tokens = [];\n    let re = chunks[0].replace(/{([^}]+)}/g, function (g, token) {\n      tokens.push(token);\n      return '([^/]+)';\n    }).replace(/\\//g, '\\\\/');\n\n    let optRe = '';\n\n    if (chunks[1]) {\n      optRe = '(?:' + chunks[1].slice(0, -1).replace(/{([^}]+)}/g, function (g, token) {\n        tokens.push(token);\n        return '([^/]+)';\n      }).replace(/\\//g, '\\\\/') + ')?';\n    }\n    return [ new RegExp('^' + re + optRe + '$'), tokens ];\n  }\n\n  route (route, callback) {\n    let routeHandler = {\n      route: route,\n      type: 's',\n      pattern: null,\n      args: [],\n      callback: callback,\n    };\n\n    if (!this.__isStatic(route)) {\n      let result = this.__routeRegExp(route);\n\n      routeHandler.type = 'v';\n      routeHandler.pattern = result[0];\n      routeHandler.args = result[1];\n    }\n\n    this.handlers.push(routeHandler);\n  }\n\n  async start () {\n    if (this.__started) {\n      return;\n    }\n\n    this.__middlewareChainRun = compose(this.middlewares);\n\n    // this.__starting = true;\n    let executed = await this.__execute();\n    // this.__starting = false;\n\n    if (executed) {\n      console.info(`Started ${this.is}:${this.__id}`);\n\n      this.__started = true;\n\n      this.__listenNavigation();\n\n      this.fire('started');\n    }\n  }\n\n  __listenNavigation () {\n    let callback = this.__executeCallback = () => {\n      this.__execute();\n    };\n\n    if (this.mode === 'history') {\n      xin.event(window).on('popstate', callback);\n      xin.event(document).on('click', evt => {\n        if (!evt.defaultPrevented && evt.target.nodeName === 'A' && evt.target.target === '') {\n          evt.preventDefault();\n\n          let state = { url: evt.target.getAttribute('href') };\n          this.history.pushState(state, evt.target.innerHTML, evt.target.href);\n\n          callback();\n        }\n      });\n    } else {\n      xin.event(window).on('hashchange', callback);\n    }\n  }\n\n  get started () {\n    return this.__started || false;\n  }\n\n  getFragmentExecutors (fragment) {\n    fragment = fragment || this.getFragment();\n\n    return this.handlers.reduce((executors, handler) => {\n      if (handler.type === 's') {\n        if (fragment === handler.route) {\n          executors.push({ handler: handler, args: {} });\n        }\n      } else if (handler.type === 'v') {\n        let result = fragment.match(handler.pattern);\n        if (result) {\n          let args = {};\n\n          handler.args.forEach(function (name, index) {\n            args[name] = result[index + 1];\n          });\n\n          executors.push({\n            handler: handler,\n            args: args,\n          });\n        }\n      }\n      return executors;\n    }, []);\n  }\n\n  async __execute () {\n    let fragment = this.getFragment();\n\n    let executors = this.getFragmentExecutors(fragment);\n    if (executors.length === 0) {\n      this.fire('route-not-found', fragment);\n      return false;\n    }\n\n    let context = { uri: fragment };\n\n    this.fire('navigated', context);\n\n    // run middleware chain then execute all executors\n    await this.__middlewareChainRun(context, () => {\n      executors.forEach(executor => executor.handler.callback(executor.args, context));\n    });\n\n    return true;\n  }\n\n  navigate (path, options) {\n    path = path || '/';\n    options = options || {};\n\n    if (this.mode === 'history') {\n      let url = this.rootUri + path.toString().replace(/\\/$/, '').replace(/^\\//, '');\n      if (this.location.href.replace(this.location.origin, '') !== url) {\n        this.history[options.replace ? 'replaceState' : 'pushState']({}, document.title, url);\n        this.__execute();\n      }\n    } else {\n      this.location.href.match(this.reHashSeparator);\n      this.location.href = this.location.href.replace(this.reHashSeparator, '') + this.hashSeparator + path;\n    }\n    return this;\n  }\n\n  use (middleware) {\n    this.middlewares.push(middleware);\n  }\n\n  getFragment () {\n    let fragment;\n    if (this.mode === 'history') {\n      fragment = decodeURI(this.location.pathname + this.location.search);\n      fragment = fragment.replace(/\\?(.*)$/, '');\n      fragment = this.rootUri === '/' ? fragment : fragment.replace(this.rootUri, '');\n    } else {\n      let match = this.location.href.match(this.reHashSeparator);\n      fragment = match ? match[1] : '';\n    }\n\n    return '/' + fragment.toString().replace(/\\/$/, '').replace(/^\\//, '');\n  }\n\n  // $back (evt) {\n  //   evt.preventDefault();\n  //   this.history.back();\n  // }\n}\n\nxin.define('xin-app', App);\n\nfunction compose (middlewares) {\n  for (const fn of middlewares) {\n    if (typeof fn !== 'function') {\n      throw new TypeError('Middleware must be composed of functions!');\n    }\n  }\n\n  return async (context, next) => {\n    // last called middlewares #\n    let index = -1;\n\n    async function dispatch (i) {\n      if (i <= index) {\n        throw new Error('next() called multiple times');\n      }\n\n      index = i;\n      let fn = middlewares[i];\n      if (i === middlewares.length) {\n        fn = next;\n      }\n      if (!fn) {\n        return;\n      }\n\n      return await fn(context, () => dispatch(i + 1));\n    }\n\n    return dispatch(0);\n  };\n}\n\nxin.App = App;\n\nexport default App;\n\n\n\n// WEBPACK FOOTER //\n// ./components/app.js"],"sourceRoot":""}